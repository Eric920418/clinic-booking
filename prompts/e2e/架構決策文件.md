# E2E Test 技術架構決策文件

## 文件目的

本文件記錄 **中醫診所 LINE 預約系統** E2E 測試的技術選型決策、架構設計和實作原則。

---

## 技術棧總覽

| 技術面向 | 選擇 | 替代方案（未選用） |
|---------|------|------------------|
| 測試框架 | Playwright | Cypress, Puppeteer |
| 測試執行器 | Playwright Test | Jest, Vitest |
| 資料庫 | Supabase PostgreSQL | SQLite, 本地 PostgreSQL |
| ORM | Prisma | Drizzle, TypeORM |
| API 模擬 | MSW (Mock Service Worker) | Nock, 手動 Mock |
| 認證機制 | JWT Token (測試專用) | Mock Auth |
| 測試隔離 | Prisma Transaction / Truncate | Fresh DB |
| 測試資料 | Factory Pattern | Hardcoded Data, Fixture Files |

---

## 詳細決策說明

### 1. 測試框架：Playwright

**選擇理由**：
- 官方支援 Next.js 整合
- 支援多瀏覽器測試（Chromium, Firefox, WebKit）
- 內建自動等待機制，減少 flaky tests
- 支援 API 測試（可同時測試前後端）
- 優秀的開發者體驗（Trace Viewer, Codegen）

**關鍵特性**：
- `test.beforeEach` / `test.afterEach` 用於測試前後處理
- `page.waitForSelector` 自動等待元素
- `page.route` 攔截和模擬 API 請求
- `expect(locator).toBeVisible()` 斷言 API

**為什麼不用 Cypress**：
- Playwright 對 Next.js App Router 支援更好
- Playwright 支援多 Tab/多視窗測試
- Playwright 測試執行速度更快

---

### 2. 測試環境：Next.js Dev Server + Supabase

**選擇理由**：
- 與生產環境一致（不使用 SQLite）
- 使用 Supabase 提供的測試資料庫
- 完整的 E2E 流程測試

**環境設定**：
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',

  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 13'] },
    },
  ],

  webServer: {
    command: 'pnpm dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
})
```

**為什麼不用 SQLite**：
- Supabase PostgreSQL 與生產環境一致
- 某些 PostgreSQL 特性在 SQLite 不支援
- E2E 測試應該盡可能接近生產環境

---

### 3. 資料庫操作：Prisma

**選擇理由**：
- 專案本身使用 Prisma
- Type-safe 的資料庫操作
- 支援 Transaction 用於測試隔離

**測試資料庫設定**：
```typescript
// tests/e2e/helpers/db.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.TEST_DATABASE_URL,
    },
  },
})

export { prisma }
```

**測試隔離策略**：
```typescript
// tests/e2e/helpers/cleanup.ts
import { prisma } from './db'

export async function cleanupDatabase() {
  // 按照外鍵依賴順序刪除
  await prisma.appointment.deleteMany()
  await prisma.timeSlot.deleteMany()
  await prisma.patient.deleteMany()
  await prisma.doctor.deleteMany()
  await prisma.treatmentType.deleteMany()
  await prisma.admin.deleteMany()
}
```

---

### 4. API 模擬：MSW (Mock Service Worker)

**選擇理由**：
- 可在瀏覽器和 Node.js 環境運行
- 攔截網路請求，不修改應用程式碼
- 支援 REST 和 GraphQL
- 可精確控制 API 回應

**使用場景**：
- 模擬 LINE LIFF API
- 模擬外部服務（SMS 發送等）
- 測試錯誤處理邏輯

**實作方式**：
```typescript
// tests/e2e/mocks/handlers.ts
import { http, HttpResponse } from 'msw'

export const handlers = [
  // 模擬 LINE LIFF 初始化
  http.get('https://api.line.me/liff/v1/info', () => {
    return HttpResponse.json({
      liffId: 'test-liff-id',
    })
  }),

  // 模擬 SMS 發送（總是成功）
  http.post('/api/liff/verify/send', () => {
    return HttpResponse.json({ success: true })
  }),
]
```

---

### 5. 認證機制：JWT Token (測試專用)

**選擇理由**：
- 簡化 E2E 測試的認證流程
- 可以直接設定已認證狀態
- 避免每次測試都走完整登入流程

**實作方式**：
```typescript
// tests/e2e/helpers/auth.ts
import jwt from 'jsonwebtoken'

export function generateTestToken(adminId: string): string {
  return jwt.sign(
    { adminId },
    process.env.JWT_SECRET!,
    { expiresIn: '1h' }
  )
}

export async function loginAsAdmin(page: Page, adminId: string) {
  const token = generateTestToken(adminId)

  // 設定 cookie 或 localStorage
  await page.context().addCookies([
    {
      name: 'admin_token',
      value: token,
      domain: 'localhost',
      path: '/',
    },
  ])
}
```

---

### 6. 測試資料：Factory Pattern

**選擇理由**：
- 統一管理測試資料建立
- 可覆寫預設值，彈性高
- 確保測試資料一致性

**實作方式**：
```typescript
// tests/e2e/factories/patient.ts
import { prisma } from '../helpers/db'

interface PatientData {
  name?: string
  phone?: string
  nationalId?: string
  lineUserId?: string
  birthDate?: Date
}

export async function createPatient(data: PatientData = {}) {
  return prisma.patient.create({
    data: {
      name: data.name ?? '測試病患',
      phone: data.phone ?? '0912345678',
      nationalId: data.nationalId ?? 'A123456789',
      lineUserId: data.lineUserId ?? `line-${Date.now()}`,
      birthDate: data.birthDate ?? new Date('1990-01-01'),
    },
  })
}

// tests/e2e/factories/doctor.ts
export async function createDoctor(data: Partial<Doctor> = {}) {
  return prisma.doctor.create({
    data: {
      name: data.name ?? '王醫師',
      specialty: data.specialty ?? '內科',
      isActive: data.isActive ?? true,
    },
  })
}

// tests/e2e/factories/appointment.ts
export async function createAppointment(data: {
  patientId: string
  doctorId: string
  treatmentTypeId: string
  timeSlotId: string
  appointmentDate: Date
}) {
  return prisma.appointment.create({
    data: {
      ...data,
      status: 'PENDING',
    },
  })
}
```

---

### 7. 測試組織結構

**目錄結構**：
```
tests/
├── e2e/
│   ├── fixtures/              # Playwright Fixtures
│   │   └── test-fixtures.ts
│   ├── factories/             # 測試資料工廠
│   │   ├── patient.ts
│   │   ├── doctor.ts
│   │   └── appointment.ts
│   ├── helpers/               # 輔助函式
│   │   ├── db.ts              # 資料庫連線
│   │   ├── auth.ts            # 認證輔助
│   │   └── cleanup.ts         # 資料清理
│   ├── mocks/                 # MSW Mock Handlers
│   │   └── handlers.ts
│   ├── liff/                  # LIFF 端測試
│   │   ├── booking.spec.ts    # 預約流程
│   │   ├── verify.spec.ts     # 驗證流程
│   │   └── profile.spec.ts    # 個人資料
│   └── admin/                 # 管理後台測試
│       ├── login.spec.ts      # 登入
│       ├── dashboard.spec.ts  # Dashboard
│       └── appointments.spec.ts # 預約管理
├── unit/                      # 單元測試
│   └── ...
└── playwright.config.ts       # Playwright 設定
```

---

## 測試範例

### LIFF 預約流程測試

```typescript
// tests/e2e/liff/booking.spec.ts
import { test, expect } from '@playwright/test'
import { createDoctor, createTreatmentType, createTimeSlot } from '../factories'
import { cleanupDatabase } from '../helpers/cleanup'

test.describe('病患預約流程', () => {
  test.beforeEach(async () => {
    await cleanupDatabase()

    // 建立測試資料
    await createDoctor({ name: '王醫師' })
    await createTreatmentType({ name: '針灸' })
    await createTimeSlot({
      date: new Date('2024-01-15'),
      startTime: '09:00',
      endTime: '09:30',
    })
  })

  test('應該能完成完整預約流程', async ({ page }) => {
    // 1. 進入 LIFF 首頁
    await page.goto('/liff')

    // 2. 選擇診療類型
    await page.click('text=針灸')
    await expect(page).toHaveURL(/\/liff\/booking\/doctor/)

    // 3. 選擇醫師
    await page.click('text=王醫師')
    await expect(page).toHaveURL(/\/liff\/booking\/time-slot/)

    // 4. 選擇時段
    await page.click('text=09:00')
    await expect(page).toHaveURL(/\/liff\/booking\/confirm/)

    // 5. 確認預約
    await page.click('text=確認預約')

    // 6. 驗證成功頁面
    await expect(page).toHaveURL(/\/liff\/booking\/success/)
    await expect(page.locator('text=預約成功')).toBeVisible()
  })

  test('時段已滿時應顯示錯誤訊息', async ({ page }) => {
    // 預先佔滿時段
    // ...

    await page.goto('/liff/booking/time-slot')
    await page.click('text=09:00')

    await expect(page.locator('text=該時段已滿')).toBeVisible()
  })
})
```

### 管理後台登入測試

```typescript
// tests/e2e/admin/login.spec.ts
import { test, expect } from '@playwright/test'
import { createAdmin } from '../factories'
import { cleanupDatabase } from '../helpers/cleanup'

test.describe('管理員登入', () => {
  test.beforeEach(async () => {
    await cleanupDatabase()
    await createAdmin({
      username: 'admin',
      password: 'hashed_password', // 使用 bcrypt hash
    })
  })

  test('正確帳密應成功登入', async ({ page }) => {
    await page.goto('/admin/login')

    await page.fill('input[name="username"]', 'admin')
    await page.fill('input[name="password"]', 'correct_password')
    await page.click('button[type="submit"]')

    await expect(page).toHaveURL(/\/admin\/dashboard/)
  })

  test('錯誤密碼應顯示錯誤訊息', async ({ page }) => {
    await page.goto('/admin/login')

    await page.fill('input[name="username"]', 'admin')
    await page.fill('input[name="password"]', 'wrong_password')
    await page.click('button[type="submit"]')

    await expect(page.locator('text=帳號或密碼錯誤')).toBeVisible()
  })

  test('連續失敗 5 次應鎖定帳號', async ({ page }) => {
    await page.goto('/admin/login')

    for (let i = 0; i < 5; i++) {
      await page.fill('input[name="username"]', 'admin')
      await page.fill('input[name="password"]', 'wrong')
      await page.click('button[type="submit"]')
    }

    await expect(page.locator('text=帳號已被鎖定')).toBeVisible()
  })
})
```

### API Route 測試

```typescript
// tests/e2e/api/appointments.spec.ts
import { test, expect } from '@playwright/test'
import { createPatient, createDoctor, createTimeSlot } from '../factories'

test.describe('預約 API', () => {
  test('POST /api/liff/appointments 應建立預約', async ({ request }) => {
    const patient = await createPatient()
    const doctor = await createDoctor()
    const timeSlot = await createTimeSlot()

    const response = await request.post('/api/liff/appointments', {
      data: {
        patientId: patient.id,
        doctorId: doctor.id,
        treatmentTypeId: 'some-id',
        timeSlotId: timeSlot.id,
        appointmentDate: '2024-01-15',
      },
    })

    expect(response.ok()).toBeTruthy()

    const body = await response.json()
    expect(body.success).toBe(true)
    expect(body.data.id).toBeDefined()
  })

  test('重複預約應回傳錯誤', async ({ request }) => {
    // 建立第一筆預約
    // ...

    // 嘗試重複預約
    const response = await request.post('/api/liff/appointments', {
      data: { /* 相同資料 */ },
    })

    expect(response.status()).toBe(400)

    const body = await response.json()
    expect(body.success).toBe(false)
    expect(body.code).toBe('E004') // 當日已有預約
  })
})
```

---

## 測試執行流程

### 1. 環境準備

```
pnpm test:e2e
  ↓
啟動 Next.js Dev Server
  ↓
連接測試資料庫 (Supabase)
  ↓
初始化 MSW (如需要)
```

### 2. 測試執行

```
每個測試檔案
  ↓
beforeEach: 清空資料庫
  ↓
beforeEach: 建立測試資料
  ↓
執行測試
  ↓
afterEach: 清理（可選）
```

### 3. 報告產生

```
所有測試完成
  ↓
產生 HTML 報告
  ↓
失敗測試產生 Trace 檔案
```

---

## 測試執行指令

```bash
# 執行所有 E2E 測試
pnpm test:e2e

# 執行特定測試檔案
pnpm test:e2e tests/e2e/liff/booking.spec.ts

# 以 UI 模式執行（開發時使用）
pnpm test:e2e --ui

# 執行並產生報告
pnpm test:e2e --reporter=html

# 只執行 LIFF 相關測試
pnpm test:e2e --grep "LIFF"

# Debug 模式
pnpm test:e2e --debug
```

---

## 環境變數設定

```bash
# .env.test
TEST_DATABASE_URL="postgresql://..."
JWT_SECRET="test-secret-key"
LIFF_ID="test-liff-id"
```

---

## 常見問題與解決方案

### Q1: 測試執行太慢？

**解決方案**：
- 使用 `fullyParallel: true` 平行執行
- 減少不必要的 `page.waitForTimeout`
- 使用 API 測試取代部分 UI 測試

### Q2: 測試不穩定 (Flaky Tests)？

**解決方案**：
- 使用 `expect(locator).toBeVisible()` 等待元素
- 避免使用 `page.waitForTimeout`
- 確保測試資料隔離

### Q3: 測試之間有資料污染？

**解決方案**：
- 確認 `beforeEach` 有執行 `cleanupDatabase()`
- 檢查是否有遺漏的表格未清理
- 注意外鍵依賴順序

### Q4: LINE LIFF 相關測試失敗？

**解決方案**：
- 使用 MSW 模擬 LINE API
- 在測試環境跳過 LIFF 初始化
- 直接設定測試用的 lineUserId

### Q5: 資料庫連線失敗？

**解決方案**：
- 確認 `TEST_DATABASE_URL` 正確設定
- 檢查 Supabase 專案是否啟動
- 確認網路連線正常

---

## 最佳實踐

### 1. 測試隔離

- 每個測試前清空相關資料
- 不依賴其他測試的資料
- 使用唯一識別碼避免衝突

### 2. 測試資料

- 使用 Factory Pattern 建立資料
- 只建立測試所需的最小資料
- 避免 hardcode 資料庫 ID

### 3. 斷言

- 使用具體的斷言（避免 `toBeTruthy`）
- 驗證重要欄位，不驗證所有欄位
- 錯誤訊息要清楚

### 4. 等待策略

```typescript
// ✅ 正確：等待特定元素
await expect(page.locator('text=預約成功')).toBeVisible()

// ❌ 錯誤：使用固定等待時間
await page.waitForTimeout(3000)
```

### 5. 選擇器

```typescript
// ✅ 優先使用 data-testid
await page.click('[data-testid="submit-btn"]')

// ✅ 使用文字內容
await page.click('text=確認預約')

// ⚠️ 避免使用 CSS class（容易變動）
await page.click('.btn-primary') // 不建議
```

---

## 與原 Python 版本的對照

| 面向 | Python/pytest | Next.js/Playwright |
|------|---------------|-------------------|
| 測試框架 | pytest | Playwright Test |
| HTTP 測試 | FastAPI TestClient | Playwright request |
| 資料庫 | Testcontainers PostgreSQL | Supabase PostgreSQL |
| ORM | SQLAlchemy | Prisma |
| 測試隔離 | Truncate tables | Prisma deleteMany |
| Context | context dict | Playwright fixtures |
| API 模擬 | 無 | MSW |

---

## 總結

本 E2E 測試架構的核心特點：

1. **真實環境**：使用 Supabase PostgreSQL，接近生產環境
2. **完整流程**：測試從 UI 到 API 到資料庫的完整流程
3. **穩定可靠**：自動等待機制減少 flaky tests
4. **易於維護**：Factory Pattern 和清晰的目錄結構
5. **快速執行**：平行執行和智慧等待
6. **行動優先**：同時測試桌面和手機版本（LINE LIFF）

這些決策確保了 E2E 測試的可靠性、可維護性和執行效率。
