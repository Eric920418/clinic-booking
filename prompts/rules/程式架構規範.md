# 程式架構規範

## 目的

本文件定義 **中醫診所 LINE 預約系統** 的程式碼組織結構、職責分層和檔案擺放規則。

---

## 技術棧

| 層級 | 技術選型 |
|------|----------|
| 前端框架 | Next.js 16+ (App Router) |
| UI 元件 | React 19+ / Tailwind CSS v4 |
| ORM | Prisma |
| 資料庫 | Supabase PostgreSQL |
| 驗證 | Zod |
| 狀態管理 | Zustand |
| LINE 整合 | LIFF v2 |

---

## 檔案組織結構

```
src/
├── app/                          # Next.js App Router
│   ├── api/                      # API Route Handlers
│   │   ├── liff/                 # 病患端 API（LINE LIFF）
│   │   │   ├── appointments/     # 預約相關
│   │   │   ├── doctors/          # 醫師查詢
│   │   │   ├── time-slots/       # 時段查詢
│   │   │   ├── treatment-types/  # 診療類型
│   │   │   └── verify/           # 驗證碼
│   │   └── admin/                # 管理後台 API
│   │       ├── auth/             # 認證（login/logout/me）
│   │       ├── appointments/     # 預約管理
│   │       └── dashboard/        # 儀表板數據
│   │
│   ├── liff/                     # 病患端頁面（LINE LIFF）
│   │   ├── page.tsx              # LIFF 入口
│   │   ├── verify/               # 驗證碼輸入
│   │   ├── profile/              # 個人資料
│   │   └── booking/              # 預約流程
│   │
│   ├── admin/                    # 管理後台頁面
│   │   ├── login/                # 登入頁
│   │   └── dashboard/            # Dashboard
│   │
│   ├── layout.tsx                # 根 Layout
│   ├── page.tsx                  # 首頁
│   └── globals.css               # 全域樣式
│
├── components/                   # React 元件
│   └── ui/                       # UI 基礎元件
│       ├── Button.tsx
│       ├── Input.tsx
│       └── Card.tsx
│
├── lib/                          # 業務邏輯與工具函式
│   ├── prisma.ts                 # Prisma Client 實例
│   ├── auth.ts                   # 認證邏輯（JWT）
│   ├── line.ts                   # LINE 相關工具
│   ├── utils.ts                  # 通用工具函式
│   ├── supabase/                 # Supabase Client
│   │   ├── client.ts             # 瀏覽器端
│   │   └── server.ts             # 伺服器端
│   └── validations/              # Zod 驗證 Schema
│       ├── patient.ts            # 病患相關驗證
│       ├── appointment.ts        # 預約相關驗證
│       └── admin.ts              # 管理員相關驗證
│
├── types/                        # TypeScript 型別定義
│   └── index.ts                  # 共用型別
│
└── prisma/
    ├── schema.prisma             # Prisma Schema（資料模型）
    └── seed.ts                   # 種子資料
```

---

## 分層架構

### Layer 1: API Route Handler（`app/api/`）

**職責**：處理 HTTP Request/Response

**負責的事**：
- 定義路由（URL path）
- 解析 HTTP Request（headers, body, query params）
- 使用 Zod 驗證輸入
- 呼叫業務邏輯（lib/）
- 使用 Prisma 存取資料庫
- 構建 HTTP Response（status code, body）
- 處理認證

**檔案位置**：`src/app/api/`

**範例**：
```typescript
// src/app/api/liff/appointments/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { createAppointmentSchema } from '@/lib/validations/appointment'

export async function POST(request: NextRequest) {
  try {
    // 解析並驗證 request body
    const body = await request.json()
    const validatedData = createAppointmentSchema.parse(body)

    // 使用 Prisma 存取資料庫
    const appointment = await prisma.appointment.create({
      data: {
        patientId: validatedData.patientId,
        doctorId: validatedData.doctorId,
        treatmentTypeId: validatedData.treatmentTypeId,
        timeSlotId: validatedData.timeSlotId,
        appointmentDate: validatedData.appointmentDate,
      },
    })

    return NextResponse.json({ success: true, data: appointment })
  } catch (error) {
    return NextResponse.json(
      { success: false, error: '預約失敗' },
      { status: 400 }
    )
  }
}
```

### Layer 2: 業務邏輯（`lib/`）

**職責**：封裝可重用的業務邏輯和工具函式

**負責的事**：
- 認證邏輯（JWT 生成/驗證）
- LINE 相關處理
- 通用工具函式
- Zod 驗證 Schema

**檔案位置**：`src/lib/`

**範例**：
```typescript
// src/lib/auth.ts
import jwt from 'jsonwebtoken'

export function verifyAdminToken(token: string) {
  try {
    return jwt.verify(token, process.env.JWT_SECRET!)
  } catch {
    return null
  }
}

export function createAdminToken(adminId: string) {
  return jwt.sign({ adminId }, process.env.JWT_SECRET!, { expiresIn: '24h' })
}
```

### Layer 3: 驗證 Schema（`lib/validations/`）

**職責**：定義輸入資料的驗證規則

**檔案位置**：`src/lib/validations/`

**範例**：
```typescript
// src/lib/validations/patient.ts
import { z } from 'zod'

export const patientSchema = z.object({
  name: z.string().min(2).max(20),
  phone: z.string().regex(/^09\d{8}$/, '請輸入有效的手機號碼'),
  nationalId: z.string().length(10, '身分證字號必須為 10 碼'),
  birthDate: z.string().datetime(),
})
```

### Layer 4: 資料存取（Prisma）

**職責**：透過 Prisma Client 操作 PostgreSQL 資料庫

**檔案位置**：
- Schema 定義：`prisma/schema.prisma`
- Client 實例：`src/lib/prisma.ts`

**範例**：
```typescript
// src/lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as { prisma: PrismaClient }

export const prisma = globalForPrisma.prisma || new PrismaClient()

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

### Layer 5: React 元件（`components/`）

**職責**：UI 呈現

**負責的事**：
- 呈現畫面
- 處理使用者互動
- 呼叫 API

**檔案位置**：`src/components/`

**範例**：
```typescript
// src/components/ui/Button.tsx
interface ButtonProps {
  children: React.ReactNode
  variant?: 'primary' | 'secondary' | 'danger'
  onClick?: () => void
  disabled?: boolean
}

export function Button({ children, variant = 'primary', ...props }: ButtonProps) {
  return (
    <button className={`btn btn-${variant}`} {...props}>
      {children}
    </button>
  )
}
```

---

## 命名規範

### 檔案命名

| 類型 | 格式 | 範例 |
|------|------|------|
| React 元件 | PascalCase | `Button.tsx`, `Card.tsx` |
| 頁面 | 小寫 + 資料夾 | `app/liff/booking/page.tsx` |
| API Route | 小寫 + 資料夾 | `app/api/liff/appointments/route.ts` |
| 工具函式 | camelCase | `auth.ts`, `utils.ts` |
| 驗證 Schema | camelCase | `patient.ts`, `appointment.ts` |

### 變數命名

| 類型 | 格式 | 範例 |
|------|------|------|
| 變數/函式 | camelCase | `patientId`, `getAppointments` |
| 常數 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT` |
| 型別/介面 | PascalCase | `Patient`, `AppointmentStatus` |
| Zod Schema | camelCase + Schema | `patientSchema`, `createAppointmentSchema` |

---

## API 路由規範

### 病患端 API（`/api/liff/`）

| 路徑 | 方法 | 說明 |
|------|------|------|
| `/api/liff/verify/send` | POST | 發送驗證碼 |
| `/api/liff/verify/check` | POST | 驗證驗證碼 |
| `/api/liff/doctors` | GET | 取得醫師列表 |
| `/api/liff/treatment-types` | GET | 取得診療類型 |
| `/api/liff/available-dates` | GET | 取得可預約日期 |
| `/api/liff/time-slots` | GET | 取得可預約時段 |
| `/api/liff/appointments` | GET/POST | 查詢/建立預約 |
| `/api/liff/appointments/[id]` | GET/PUT/DELETE | 查詢/更新/取消預約 |

### 管理後台 API（`/api/admin/`）

| 路徑 | 方法 | 說明 |
|------|------|------|
| `/api/admin/auth/login` | POST | 管理員登入 |
| `/api/admin/auth/logout` | POST | 管理員登出 |
| `/api/admin/auth/me` | GET | 取得當前管理員資訊 |
| `/api/admin/appointments` | GET | 取得預約列表 |
| `/api/admin/appointments/[id]/status` | PATCH | 更新預約狀態 |
| `/api/admin/dashboard/summary` | GET | Dashboard 摘要 |
| `/api/admin/dashboard/weekly` | GET | 週流量統計 |

---

## 錯誤處理規範

### API 錯誤回應格式

```typescript
// 成功
{ success: true, data: { ... } }

// 失敗
{ success: false, error: '錯誤訊息', code: 'E001' }
```

### 錯誤代碼

| 代碼 | 說明 |
|------|------|
| E001 | 驗證碼錯誤 |
| E002 | 驗證碼過期 |
| E003 | 時段已滿 |
| E004 | 當日已有預約 |
| E005 | 帳號已被停權 |
| E006 | 登入失敗次數過多 |
| E007 | 無此預約 |
| E008 | 無法修改已完成的預約 |

### 前端錯誤顯示

所有錯誤必須完整顯示在前端，讓使用者清楚知道發生什麼問題：

```typescript
// ✅ 正確：顯示完整錯誤
try {
  await createAppointment(data)
} catch (error) {
  toast.error(error.message || '預約失敗，請稍後再試')
}

// ❌ 錯誤：吞掉錯誤
try {
  await createAppointment(data)
} catch (error) {
  console.error(error) // 使用者看不到
}
```

---

## 資料庫規範

### 禁止事項

- ❌ 禁止使用 `--accept-data-loss` 參數
- ❌ 禁止直接刪除有資料的欄位
- ❌ 禁止使用 `db push --force-reset`

### Migration 流程

```bash
# 1. 修改 schema.prisma
# 2. 建立 migration
pnpm db:migrate

# 3. 產生 Prisma Client
pnpm db:generate
```

---

## 套件管理

僅使用 **pnpm** 管理套件：

```bash
# ✅ 正確
pnpm add <package>
pnpm install

# ❌ 禁止
npm install
yarn add
```

---

## 架構檢查清單

開發時確保符合以下條件：

- [ ] API Route Handler 在 `src/app/api/` 目錄下
- [ ] 驗證 Schema 在 `src/lib/validations/` 目錄下
- [ ] React 元件在 `src/components/` 目錄下
- [ ] 型別定義在 `src/types/` 目錄下
- [ ] 使用 Prisma 存取資料庫，不直接寫 SQL
- [ ] 所有輸入都經過 Zod 驗證
- [ ] 所有錯誤都完整顯示在前端
- [ ] 使用 pnpm 管理套件

---

## 常見錯誤

### ❌ 錯誤 1：在 API Route 中不驗證輸入

```typescript
// ❌ 錯誤：直接使用未驗證的輸入
export async function POST(request: NextRequest) {
  const body = await request.json()
  await prisma.patient.create({ data: body }) // 危險！
}

// ✅ 正確：使用 Zod 驗證
export async function POST(request: NextRequest) {
  const body = await request.json()
  const validatedData = patientSchema.parse(body)
  await prisma.patient.create({ data: validatedData })
}
```

### ❌ 錯誤 2：在元件中直接操作資料庫

```typescript
// ❌ 錯誤：React 元件直接使用 Prisma
function PatientList() {
  const patients = await prisma.patient.findMany() // 錯誤！
}

// ✅ 正確：透過 API 取得資料
function PatientList() {
  const [patients, setPatients] = useState([])
  useEffect(() => {
    fetch('/api/liff/patients').then(res => res.json()).then(setPatients)
  }, [])
}
```

### ❌ 錯誤 3：吞掉錯誤

```typescript
// ❌ 錯誤：不顯示錯誤給使用者
try {
  await submitForm()
} catch (e) {
  console.log(e)
}

// ✅ 正確：顯示錯誤給使用者
try {
  await submitForm()
} catch (e) {
  setError(e.message)
}
```

---

## 總結

遵循本架構規範可以確保：

1. **職責清晰**：每層只負責自己的事
2. **易於維護**：檔案組織清晰，容易找到對應的程式碼
3. **安全性**：所有輸入都經過驗證，錯誤都正確處理
4. **一致性**：團隊成員遵循相同的開發規範
