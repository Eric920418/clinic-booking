# TDD é‡æ§‹éšæ®µï¼šæ”¹å–„ç¨‹å¼ç¢¼å“è³ª

## ç›®æ¨™

åœ¨ä¿æŒæ¸¬è©¦é€šéï¼ˆç¶ ç‡ˆ ğŸŸ¢ï¼‰çš„å‰æä¸‹ï¼Œæ”¹å–„ç¨‹å¼ç¢¼å“è³ªã€‚

---

## æ ¸å¿ƒåŸå‰‡

### 1. æ¸¬è©¦ä¿è­·åŸå‰‡
æ¯æ¬¡é‡æ§‹å¾Œç«‹å³åŸ·è¡Œæ¸¬è©¦ï¼Œç¢ºä¿å…¨éƒ¨é€šéã€‚è‹¥å¤±æ•—å‰‡ç«‹å³å›æ»¾ã€‚

### 2. å°æ­¥å‰é€²åŸå‰‡
ä¸€æ¬¡åªåšä¸€å€‹å°é‡æ§‹ï¼Œé¿å…ä¸€æ¬¡æ”¹å‹•éå¤šã€‚

### 3. ä¸å¼·è¡Œé‡æ§‹åŸå‰‡
åªåœ¨çœŸæ­£æœ‰æ”¹å–„ç©ºé–“æ™‚æ‰é‡æ§‹ã€‚ç¨‹å¼ç¢¼å·²æ¸…æ™°ç°¡æ½”æ™‚ä¿æŒåŸæ¨£ï¼Œéµå¾ª YAGNI åŸå‰‡ã€‚

### 4. è¨­è¨ˆåŸå‰‡éµå®ˆ
é‡æ§‹æ™‚å¿…é ˆéµå®ˆ SOLID è¨­è¨ˆåŸå‰‡ï¼Œé”åˆ°å¥½è®€ã€å¥½ç¶­è­·ã€å¥½æ“´å……ã€‚

### 5. æ¶æ§‹è¦ç¯„éµå®ˆ
**åš´æ ¼éµå®ˆ** `prompts/rules/ç¨‹å¼æ¶æ§‹è¦ç¯„.md`ï¼Œç¢ºä¿åˆ†å±¤æ¸…æ™°ã€è·è²¬æ˜ç¢ºã€‚

### 6. æ¸¬è©¦ Warnings æ¸…ç†
**ç›¡å¯èƒ½æ¸…é™¤æ‰€æœ‰æ¸¬è©¦ warnings**ï¼Œä¿æŒæ¸¬è©¦è¼¸å‡ºä¹¾æ·¨ã€‚warnings é€šå¸¸æŒ‡å‡ºæ½›åœ¨å•é¡Œæˆ–éæ™‚ç”¨æ³•ã€‚

---

## é‡æ§‹æ”¹å–„æ–¹å‘

### 1. SOLID è¨­è¨ˆåŸå‰‡

#### S - Single Responsibility Principleï¼ˆå–®ä¸€è·è²¬åŸå‰‡ï¼‰
æ¯å€‹é¡åˆ¥/å‡½å¼åªè² è²¬ä¸€ä»¶äº‹ã€‚

**ç¯„ä¾‹ï¼š**
```python
# âŒ Service åšå¤ªå¤šäº‹
class LessonProgressService:
    def update_progress(self, user_id, lesson_id, progress):
        # é©—è­‰æ¬Šé™
        if not self._check_permission(user_id):
            raise PermissionError()
        # é©—è­‰é€²åº¦
        if progress < 0 or progress > 100:
            raise ValueError()
        # å„²å­˜è³‡æ–™
        self.repository.save(...)
        # ç™¼é€é€šçŸ¥
        self._send_notification(user_id)

# âœ… è·è²¬åˆ†é›¢
class LessonProgressService:
    def __init__(self, progress_repo, permission_validator, notification_service):
        self.progress_repo = progress_repo
        self.permission_validator = permission_validator
        self.notification_service = notification_service
    
    def update_progress(self, user_id, lesson_id, progress):
        self.permission_validator.validate(user_id)  # æ¬Šé™é©—è­‰äº¤çµ¦å°ˆé–€çš„é¡åˆ¥
        lesson_progress = LessonProgress(user_id, lesson_id, progress)
        self.progress_repo.save(lesson_progress)
        self.notification_service.notify(user_id)  # é€šçŸ¥äº¤çµ¦å°ˆé–€çš„æœå‹™
```

#### D - Dependency Inversion Principleï¼ˆä¾è³´åè½‰åŸå‰‡ï¼‰
é«˜å±¤æ¨¡çµ„ä¸æ‡‰ä¾è³´ä½å±¤æ¨¡çµ„ï¼Œå…©è€…éƒ½æ‡‰ä¾è³´æŠ½è±¡ã€‚

**ç¯„ä¾‹ï¼š**
```python
# âœ… Service é€éå»ºæ§‹å­æ³¨å…¥ Repository
class LessonProgressService:
    def __init__(self, lesson_progress_repo, lesson_repo, subscription_repo):
        self.lesson_progress_repo = lesson_progress_repo
        self.lesson_repo = lesson_repo
        self.subscription_repo = subscription_repo
    
    def get_progress(self, user_id, lesson_id):
        # æ¥­å‹™é‚è¼¯ä½¿ç”¨æ³¨å…¥çš„ repository
        subscription = self.subscription_repo.find_by_user(user_id)
        if not subscription:
            raise SubscriptionNotFoundError()
        # ...
```

### 2. æ¶æ§‹è¦ç¯„éµå®ˆ

#### åˆ†å±¤æ¶æ§‹æª¢æŸ¥

**Service (domain services)**ï¼š
- âœ… åŒ…å«æ¥­å‹™é‚è¼¯å’Œè¦å‰‡
- âœ… é€éå»ºæ§‹å­æ³¨å…¥ Repository
- âŒ ä¸ç›´æ¥æ“ä½œè³‡æ–™åº«
- âŒ ä¸åŒ…å« HTTP è™•ç†é‚è¼¯

**Repository (data access)**ï¼š
- âœ… å°è£è³‡æ–™å­˜å–é‚è¼¯
- âœ… åœ¨ UT ä¸­ä½¿ç”¨è¨˜æ†¶é«”å…§å¯¦ä½œ
- âŒ ä¸åŒ…å«æ¥­å‹™é‚è¼¯

#### ç¯„ä¾‹ï¼šç¬¦åˆæ¶æ§‹è¦ç¯„çš„é‡æ§‹

**é‡æ§‹å‰ï¼ˆé•åä¾è³´æ³¨å…¥ï¼‰ï¼š**
```python
class LessonProgressService:
    def __init__(self):
        # âŒ Service å…§éƒ¨ç›´æ¥å»ºç«‹ Repository
        self.progress_repo = LessonProgressRepository()
        self.subscription_repo = JourneySubscriptionRepository()
    
    def update_progress(self, user_id, lesson_id, progress):
        # æ¥­å‹™é‚è¼¯...
        pass
```

**é‡æ§‹å¾Œï¼ˆç¬¦åˆä¾è³´æ³¨å…¥ï¼‰ï¼š**
```python
class LessonProgressService:
    def __init__(self, progress_repo, subscription_repo):
        # âœ… é€éå»ºæ§‹å­æ³¨å…¥ Repository
        self.progress_repo = progress_repo
        self.subscription_repo = subscription_repo
    
    def update_progress(self, user_id, lesson_id, progress):
        # âœ… ä½¿ç”¨æ³¨å…¥çš„ repository
        subscription = self.subscription_repo.find_by_user(user_id)
        if not subscription:
            raise SubscriptionNotFoundError()
        # ...
```

### 3. ç¨‹å¼ç¢¼å“è³ªæ”¹å–„

#### æ¶ˆé™¤é‡è¤‡é‚è¼¯
```python
# âŒ é‡è¤‡çš„è¨‚é–±é©—è­‰
def update_progress(self, user_id, ...):
    subscription = self.subscription_repo.find_by_user(user_id)
    if not subscription:
        raise SubscriptionNotFoundError()
    # ...

def get_progress(self, user_id, ...):
    subscription = self.subscription_repo.find_by_user(user_id)
    if not subscription:
        raise SubscriptionNotFoundError()
    # ...

# âœ… æå–å…±ç”¨æ–¹æ³•
def _validate_subscription(self, user_id):
    subscription = self.subscription_repo.find_by_user(user_id)
    if not subscription:
        raise SubscriptionNotFoundError()
    return subscription

def update_progress(self, user_id, ...):
    subscription = self._validate_subscription(user_id)
    # ...

def get_progress(self, user_id, ...):
    subscription = self._validate_subscription(user_id)
    # ...
```

---

### 3. æ¸¬è©¦ Warnings æ¸…ç†

#### ç›®çš„
æ¸…é™¤æ¸¬è©¦åŸ·è¡Œæ™‚ç”¢ç”Ÿçš„æ‰€æœ‰ warningsï¼Œä¿æŒæ¸¬è©¦è¼¸å‡ºä¹¾æ·¨ã€‚

#### å¸¸è¦‹ Warnings é¡å‹

**1. DeprecationWarningï¼ˆéæ™‚è­¦å‘Šï¼‰**
```python
# âŒ ä½¿ç”¨éæ™‚çš„ API
warnings.warn("This method is deprecated", DeprecationWarning)

# âœ… æ”¹ç”¨æ–°çš„ API
# æ ¹æ“š warning è¨Šæ¯æ›´æ–°ç‚ºæ¨è–¦çš„æ–°æ–¹æ³•
```

**2. PytestUnraisableExceptionWarningï¼ˆæœªæ•ç²ç•°å¸¸ï¼‰**
```python
# âŒ è³‡æºæœªæ­£ç¢ºé—œé–‰
def test_example():
    file = open("test.txt")
    # å¿˜è¨˜é—œé–‰æª”æ¡ˆ

# âœ… ä½¿ç”¨ context manager
def test_example():
    with open("test.txt") as file:
        # è‡ªå‹•é—œé–‰
        pass
```

**3. è¨˜æ†¶é«”æˆ–è³‡æºæ´©æ¼è­¦å‘Š**
```python
# âŒ ç‰©ä»¶æœªæ­£ç¢ºæ¸…ç†
@pytest.fixture
def setup_service():
    service = MyService()
    yield service
    # ç¼ºå°‘æ¸…ç†

# âœ… æ­£ç¢ºæ¸…ç†è³‡æº
@pytest.fixture
def setup_service():
    service = MyService()
    yield service
    service.cleanup()  # ç¢ºä¿æ¸…ç†
```

#### æ¸…ç†æ­¥é©Ÿ

1. **åŸ·è¡Œæ¸¬è©¦ä¸¦æª¢æŸ¥ warnings**
```bash
pytest tests/ut/ -v --tb=short
```

2. **é‡å°æ¯å€‹ warning é€²è¡Œä¿®æ­£**
- é–±è®€ warning è¨Šæ¯
- æ‰¾åˆ°å•é¡Œæºé ­
- æ ¹æ“šå»ºè­°ä¿®æ­£

3. **é©—è­‰ warnings å·²æ¸…é™¤**
```bash
pytest tests/ut/ -v --tb=short  # æ‡‰è©²æ²’æœ‰ warnings
```

4. **ç¢ºä¿æ¸¬è©¦ä»ç„¶é€šé** âœ…

---

## UT é‡æ§‹é …ç›®

### 1. Meta è¨»è¨˜æ¸…ç†

#### åˆªé™¤çš„å…§å®¹
- `# [äº‹ä»¶é¢¨æš´éƒ¨ä½: ...]`
- `# [ç”Ÿæˆåƒè€ƒ Prompt: ...]`

#### ä¿ç•™çš„å…§å®¹
- Given/When/Then/And æ¥­å‹™é‚è¼¯æè¿°
- å¿…è¦çš„æŠ€è¡“è¨»è§£ï¼ˆå¦‚ "Extract repositories and services"ï¼‰

#### ç¯„ä¾‹

**é‡æ§‹å‰ï¼š**
```python
def test_æ›´æ–°å½±ç‰‡é€²åº¦(self, setup_background):
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 50%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Aggregate-Given-Handler.md]
    
    lesson_service = setup_background["lesson_service"]
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Command - update_progress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Command-Handler.md]
    
    lesson_service.update_progress(user_id="Alice", lesson_id=1, progress=70)
    
    # Then æ“ä½œæˆåŠŸ
    # [ç”Ÿæˆåƒè€ƒ Prompt: Success-Failure-Handler.md]
    assert True
```

**é‡æ§‹å¾Œï¼š**
```python
def test_æ›´æ–°å½±ç‰‡é€²åº¦(self, setup_background):
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 50%
    lesson_service = setup_background["lesson_service"]
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%
    lesson_service.update_progress(user_id="Alice", lesson_id=1, progress=70)
    
    # Then æ“ä½œæˆåŠŸ
    assert True
```

---

### 2. Setup Background Fixture

#### ç›®çš„
å°‡é‡è¤‡çš„ä¾è³´åˆå§‹åŒ–ä»£ç¢¼æå–åˆ° pytest fixture ä¸­ï¼Œæ¸›å°‘é‡è¤‡ã€‚

#### ç¯„ä¾‹

**Setup Background Fixtureï¼š**
```python
@pytest.fixture
def setup_background():
    """Background: æ¸¬è©¦çš„å…±ç”¨å‰ç½®æ¢ä»¶"""
    # åˆå§‹åŒ– repositories
    lesson_progress_repo = LessonProgressRepository()
    lesson_repo = LessonRepository()
    user_repo = UserRepository()
    subscription_repo = JourneySubscriptionRepository()
    
    # åˆå§‹åŒ– servicesï¼ˆé€éä¾è³´æ³¨å…¥ï¼‰
    lesson_service = LessonService(
        lesson_progress_repository=lesson_progress_repo,
        lesson_repository=lesson_repo,
        user_repository=user_repo,
        subscription_repository=subscription_repo,
    )
    
    # Given ç³»çµ±ä¸­æœ‰ä»¥ä¸‹ç”¨æˆ¶
    user_alice = User(name="Alice", level=1, exp=0)
    user_repo.save(user_alice)
    
    # And ç³»çµ±ä¸­æœ‰ä»¥ä¸‹èª²ç¨‹
    lesson1 = Lesson(name="ç‰©ä»¶å°å‘åŸºç¤", type="video")
    lesson_repo.save(lesson1)
    
    # And ç”¨æˆ¶ "Alice" å·²è¨‚é–±æ—…ç¨‹ 1
    subscription_repo.subscribe("Alice", 1)
    
    return {
        "lesson_progress_repository": lesson_progress_repo,
        "lesson_service": lesson_service,
        "user_repository": user_repo,
    }
```

**æ¸¬è©¦æ–¹æ³•ä½¿ç”¨ Fixtureï¼š**
```python
def test_æ›´æ–°å½±ç‰‡é€²åº¦(self, setup_background):
    # Extract repositories and services
    lesson_progress_repo = setup_background["lesson_progress_repository"]
    lesson_service = setup_background["lesson_service"]
    
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 50%
    progress = LessonProgress(user_id="Alice", lesson_id=1, progress=50)
    lesson_progress_repo.save(progress)
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%
    lesson_service.update_progress(user_id="Alice", lesson_id=1, progress=70)
    
    # Then é€²åº¦æ‡‰æ›´æ–°ç‚º 70%
    updated = lesson_progress_repo.find_by_user_and_lesson("Alice", 1)
    assert updated.progress == 70
```

---

## é‡æ§‹æª¢æŸ¥æ¸…å–®

åŸ·è¡Œ UT æ¸¬è©¦é‡æ§‹æ™‚ç¢ºèªï¼š

### æ¸¬è©¦ç¨‹å¼ç¢¼
- [ ] æ‰€æœ‰ Meta è¨»è¨˜å·²åˆªé™¤
- [ ] Given/When/Then æ¥­å‹™é‚è¼¯è¨»è§£å·²ä¿ç•™
- [ ] æ‰€æœ‰æ¸¬è©¦éƒ½ä½¿ç”¨ `setup_background` fixture
- [ ] æ¸¬è©¦æ–¹æ³•åªæå–éœ€è¦çš„ä¾è³´
- [ ] Feature Background çš„æ•¸æ“šå·²ç§»åˆ° fixture

### å¯¦ä½œç¨‹å¼ç¢¼
- [ ] ç¬¦åˆ SOLID è¨­è¨ˆåŸå‰‡
- [ ] Service é€éå»ºæ§‹å­æ³¨å…¥ Repository
- [ ] Repository ä¸åŒ…å«æ¥­å‹™é‚è¼¯
- [ ] éµå®ˆ `prompts/rules/ç¨‹å¼æ¶æ§‹è¦ç¯„.md`
- [ ] æ¶ˆé™¤é‡è¤‡é‚è¼¯ï¼ˆæå–å…±ç”¨æ–¹æ³•ï¼‰

### æ¸¬è©¦é©—è­‰
- [ ] æ‰€æœ‰æ¸¬è©¦é€šé ğŸŸ¢
- [ ] æ‰€æœ‰æ¸¬è©¦ warnings å·²æ¸…é™¤

---

## é‡æ§‹åŸå‰‡ç¸½çµ

âœ… **æ‡‰è©²åšï¼š**
- æ¸…ç† Meta è¨»è¨˜
- ä¿ç•™æ¥­å‹™é‚è¼¯è¨»è§£
- æå–ä¾è³´åˆ° setup_background fixture
- éµå®ˆ SOLID è¨­è¨ˆåŸå‰‡
- åš´æ ¼éµå®ˆæ¶æ§‹è¦ç¯„ï¼ˆä¾è³´æ³¨å…¥ã€è·è²¬åˆ†é›¢ï¼‰
- æ¸…é™¤æ‰€æœ‰æ¸¬è©¦ warnings

âŒ **ä¸æ‡‰è©²åšï¼š**
- å°‡æ¸¬è©¦ç‰¹å®šæ•¸æ“šæ”¾å…¥ fixture
- æ”¹è®Šæ¸¬è©¦çµæ§‹
- å¼·è¡Œç°¡åŒ–å¯è®€æ€§
- Service å…§éƒ¨ç›´æ¥å»ºç«‹ Repository
- å¿½ç•¥æ¸¬è©¦ warnings


